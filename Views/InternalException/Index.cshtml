@using ExpressBase.Common.Helpers
@using ExpressBase.Web.Controllers.ControllersV2
@using Microsoft.Extensions.Configuration
@inject IConfiguration Configuration
@model InternalExceptionViewModel

@{
    bool isDev = Model.IsDevelopment;
    string ticketId = Model.TicketId;
    SerializableExceptionDto exception = Model.Exception;
    bool hasTicket = (exception != null);
    string baseUrl = Configuration["AppSettings:Scheme"] + Configuration["AppSettings:BaseHost"];
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Something went wrong | @ticketId</title>
    @await Html.PartialAsync("_EbCoreScripts")
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root {
            --bg: #f6f7f9;
            --fg: #0b0c0e;
            --muted: #5b616e;
            --card: #fff;
            --border: #e5e7eb;
            --accent: #2563eb;
            --danger: #b91c1c;
            --mono: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
            --font: system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";
        }

        @@media (prefers-color-scheme: dark) {
            :root {
                --bg: #0b0c0e;
                --fg: #e5e7eb;
                --muted: #9aa0aa;
                --card: #111317;
                --border: #1f232a;
                --accent: #60a5fa;
                --danger: #f87171;
            }
        }

        html, body {
            height: 100%;
            margin: 0;
            background: var(--bg);
            color: var(--fg);
            font-family: var(--font);
        }

        .wrap {
            min-height: 100%;
            display: grid;
            place-items: center;
            padding: 24px;
        }

        .card {
            width: 100%;
            max-width: 900px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            box-sizing: border-box;
            box-shadow: 0 10px 30px rgba(0,0,0,.12);
            text-align: left; /* lean everything left */
        }

        .logo {
            display: block;
            margin: 0 0 20px 0; /* left-aligned */
            max-width: 160px;
            height: auto;
        }

        .title {
            margin: 0 0 8px;
            font-size: 22px;
            font-weight: 700;
        }

        .subtitle {
            margin: 0 0 16px;
            color: var(--muted);
            font-size: 14px;
        }

        details {
            border: 1px dashed var(--border);
            border-radius: 12px;
            padding: 12px 14px;
            margin-top: 16px;
        }

            details > summary {
                cursor: pointer;
                font-weight: 600;
            }

        .kv {
            margin-top: 8px;
        }

            .kv dt {
                font-weight: 600;
                font-size: 12px;
                color: var(--muted);
            }

            .kv dd {
                margin: 0 0 10px 0;
                font-family: var(--mono);
                white-space: pre-wrap;
                word-break: break-word;
            }

        .mono {
            font-family: var(--mono);
        }

        .danger {
            color: var(--danger);
        }

        .muted {
            color: var(--muted);
        }

        .row {
            display: flex;
            justify-content: flex-end; /* buttons to the right */
            gap: 12px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .btn {
            appearance: none;
            border: 1px solid var(--border);
            padding: 10px 14px;
            border-radius: 10px;
            cursor: pointer;
            background: transparent;
            color: var(--fg);
            font-weight: 600;
        }

            .btn:hover {
                border-color: var(--accent);
            }

        .btn-primary {
            background: var(--accent);
            border-color: var(--accent);
            color: #fff;
        }

        .btn-primary:hover {
           filter: brightness(1.05);
        }

        .stack-frame {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            overflow-x: auto;
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Courier New", monospace;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
            max-height: 300px;
            white-space: pre-wrap;
        }

        .stack-frame pre {
           margin: 0;
           font-size: 0.875rem;
        }

    </style>

</head>
<body>
    <div class="wrap">
        <div class="card">
            <img src="@baseUrl/images/EB_Logo.png" alt="EB Logo" class="logo" />

            <h1 class="title" id="errorTitle">Something went wrong</h1>

            @if (hasTicket)
            {
                <p class="subtitle">Ticket ID: <span class="mono">@ticketId</span></p>
            }

            @if (!hasTicket)
            {
                if (isDev)
                {
                    <p class="subtitle" >
                        No error details present. In Dev, ensure you redirected here using a valid ticket created within the TTL.
                    </p>

                    <p class="subtitle" id="errorSubtitle">
                        We’re sorry, but something didn’t go as expected. Don’t worry, our team has been notified and is already looking into it.
                        Please try reloading the page or return to the homepage.
                    </p>
                }
                else
                {
                    <p class="subtitle" id="errorSubtitle">
                        We’re sorry, but something didn’t go as expected. Don’t worry, our team has been notified and is already looking into it.
                        Please try reloading the page or return to the homepage.
                    </p>
                }
            }

            @if (hasTicket && isDev)
            {
                <details open>
                    <summary>Details</summary>
                    <dl class="kv">
                        @if (!string.IsNullOrEmpty(exception?.GetType().FullName))
                        {
                            <dt>Exception Type</dt>
                            <dd>@exception.GetType().FullName</dd>
                        }

                        @if (!string.IsNullOrEmpty(exception?.Message))
                        {
                            <dt>Message</dt>
                            <dd>@exception.Message</dd>
                        }

                        @if (!string.IsNullOrEmpty(exception?.Source))
                        {
                            <dt>Source</dt>
                            <dd>@exception.Source</dd>
                        }

                        @if (!string.IsNullOrEmpty(exception?.TargetSite?.ToString()))
                        {
                            <dt>Target Site</dt>
                            <dd>@exception.TargetSite.ToString()</dd>
                        }

                        @if (exception?.Data?.Count > 0)
                        {
                            <dt>Data</dt>
                            <dd>
                                <ul>
                                    @foreach (var kvp in exception.Data)
                                    {
                                        <li><strong>@kvp.Key:</strong> @kvp.Value</li>
                                    }
                                </ul>
                            </dd>
                        }

                        @if (!string.IsNullOrEmpty(exception?.StackTrace))
                        {
                            <dt>Stack Trace</dt>
                            <dd>
                                <div class="stack-frame">
                                    <pre>@exception.StackTrace</pre>
                                </div>
                            </dd>
                        }

                        @if (exception?.InnerException != null)
                        {
                            <dt>Inner Exception</dt>
                            <dd>
                                <details>
                                    <summary>@exception.InnerException.Message</summary>
                                    <dl class="kv">
                                        <dt>Type</dt>
                                        <dd>@exception.InnerException.GetType().FullName</dd>

                                        @if (!string.IsNullOrEmpty(exception.InnerException.Source))
                                        {
                                            <dt>Source</dt>
                                            <dd>@exception.InnerException.Source</dd>
                                        }

                                        @if (!string.IsNullOrEmpty(exception.InnerException.StackTrace))
                                        {
                                            <dt>Stack Trace</dt>
                                            <dd>
                                                <div class="stack-frame">
                                                    <pre>@exception.InnerException.StackTrace</pre>
                                                </div>
                                            </dd>
                                        }

                                        @if (exception.InnerException.Data?.Count > 0)
                                        {
                                            <dt>Data</dt>
                                            <dd>
                                                <ul>
                                                    @foreach (var kvp in exception.InnerException.Data)
                                                    {
                                                        <li><strong>@kvp.Key:</strong> @kvp.Value</li>
                                                    }
                                                </ul>
                                            </dd>
                                        }
                                    </dl>
                                </details>
                            </dd>
                        }
                    </dl>
                </details>

            }

            <div class="row">
                <button class="btn" onclick="location.href='/'">Go Home</button>
                @* <button class="btn btn-primary" onclick="location.reload()">Reload</button> *@
            </div>
        </div>
    </div>

    <script>
        addEventListener('orientationchange', function () {
            setTimeout(function () { scrollTo(0, 0); }, 200);
        });

        (function () {
            const titles = [
                "Something went wrong",
                "We hit a small snag",
                "An unexpected issue occurred",
                "Looks like we ran into a problem",
                "Oops! that didn’t go as planned",
                "Something didn’t load as expected",
                "We’re working to fix this",
                "A quick fix is on the way"
            ];

            const subtitles = [
                "We’re sorry, but something didn’t go as expected. Don’t worry our team has been notified and is already looking into it.",
                "It seems something went off track. Everything’s fine, please try reloading the page or return to the homepage.",
                "We ran into a temporary issue, but it should be resolved soon. You can safely reload or go back to the homepage.",
                "Our systems are catching their breath. Try refreshing the page or check back in a moment.",
                "Hmm, something didn’t go as planned. We’re already on it, please try again shortly."
            ];

            const title = titles[Math.floor(Math.random() * titles.length)];
            const subtitle = subtitles[Math.floor(Math.random() * subtitles.length)];

            const titleEl = document.getElementById("errorTitle");
            const subtitleEl = document.getElementById("errorSubtitle");

            if (titleEl) titleEl.textContent = title;
            if (subtitleEl) subtitleEl.textContent = subtitle;

        })();

    </script>
</body>
</html>
