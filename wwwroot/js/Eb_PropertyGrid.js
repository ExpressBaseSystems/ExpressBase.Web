var Gcolumns = { "$type": "ExpressBase.Objects.EbTableVisualization, ExpressBase.Objects", "IsPaged": "", "rowGrouping": ["serial", "checkbox"], "DataSourceRefId": "eb_roby_dev-eb_roby_dev-2-519-1165", "Ebsid": "set1_EbTableVisualization0_1", "Columns": { "$type": "ExpressBase.Objects.Objects.DVRelated.DVColumnCollection, ExpressBase.Objects", "$values": [{ "$type": "ExpressBase.Objects.Objects.DVRelated.DVNumericColumn, ExpressBase.Objects", "Aggregate": false, "DecimalPlaces": 0, "RenderAs": 0, "LinkRefId": null, "data": 0, "name": "serial", "Type": 12, "sTitle": "#", "bVisible": true, "Pos": -2, "sWidth": "10px", "className": null, "fontfamily": 0, "Id": 0, "RefId": null, "EbObjectType": 0, "ChangeLog": null }, { "$type": "ExpressBase.Objects.Objects.DVRelated.DVBooleanColumn, ExpressBase.Objects", "IsEditable": false, "RenderAs": 0, "data": 0, "name": "checkbox", "Type": 3, "sTitle": "checkbox", "bVisible": false, "Pos": -1, "sWidth": "10px", "className": null, "fontfamily": 0, "Id": 0, "RefId": null, "EbObjectType": 0, "ChangeLog": null }, { "$type": "ExpressBase.Objects.Objects.DVRelated.DVNumericColumn, ExpressBase.Objects", "Aggregate": false, "DecimalPlaces": 0, "RenderAs": 0, "LinkRefId": null, "data": 0, "name": "id", "Type": 11, "sTitle": "id", "bVisible": true, "Pos": 124, "sWidth": "100px", "className": "tdheight", "fontfamily": 0, "Id": 0, "RefId": null, "EbObjectType": 0, "ChangeLog": null }, { "$type": "ExpressBase.Objects.Objects.DVRelated.DVStringColumn, ExpressBase.Objects", "RenderAs": 0, "LinkRefId": null, "data": 1, "name": "xid", "Type": 16, "sTitle": "xid", "bVisible": true, "Pos": 124, "sWidth": "100px", "className": "tdheight", "fontfamily": 0, "Id": 0, "RefId": null, "EbObjectType": 0, "ChangeLog": null }, { "$type": "ExpressBase.Objects.Objects.DVRelated.DVDateTimeColumn, ExpressBase.Objects", "Format": 0, "RenderAs": 0, "LinkRefId": null, "data": 2, "name": "trndate", "Type": 6, "sTitle": "trndate", "bVisible": true, "Pos": 124, "sWidth": "100px", "className": "tdheight", "fontfamily": 0, "Id": 0, "RefId": null, "EbObjectType": 0, "ChangeLog": null }, { "$type": "ExpressBase.Objects.Objects.DVRelated.DVStringColumn, ExpressBase.Objects", "RenderAs": 0, "LinkRefId": null, "data": 3, "name": "cash_or_cre", "Type": 16, "sTitle": "cash_or_cre", "bVisible": true, "Pos": 124, "sWidth": "100px", "className": "tdheight", "fontfamily": 0, "Id": 0, "RefId": null, "EbObjectType": 0, "ChangeLog": null }, { "$type": "ExpressBase.Objects.Objects.DVRelated.DVBooleanColumn, ExpressBase.Objects", "IsEditable": false, "RenderAs": 0, "data": 4, "name": "cash2", "Type": 3, "sTitle": "cash2", "bVisible": true, "Pos": 124, "sWidth": "100px", "className": "tdheight", "fontfamily": 0, "Id": 0, "RefId": null, "EbObjectType": 0, "ChangeLog": null }, { "$type": "ExpressBase.Objects.Objects.DVRelated.DVStringColumn, ExpressBase.Objects", "RenderAs": 0, "LinkRefId": null, "data": 5, "name": "lpo", "Type": 16, "sTitle": "lpo", "bVisible": true, "Pos": 124, "sWidth": "100px", "className": "tdheight", "fontfamily": 0, "Id": 0, "RefId": null, "EbObjectType": 0, "ChangeLog": null }, { "$type": "ExpressBase.Objects.Objects.DVRelated.DVStringColumn, ExpressBase.Objects", "RenderAs": 0, "LinkRefId": null, "data": 6, "name": "dispname", "Type": 16, "sTitle": "dispname", "bVisible": true, "Pos": 124, "sWidth": "100px", "className": "tdheight", "fontfamily": 0, "Id": 0, "RefId": null, "EbObjectType": 0, "ChangeLog": null }, { "$type": "ExpressBase.Objects.Objects.DVRelated.DVNumericColumn, ExpressBase.Objects", "Aggregate": false, "DecimalPlaces": 0, "RenderAs": 0, "LinkRefId": null, "data": 7, "name": "discount", "Type": 7, "sTitle": "discount", "bVisible": true, "Pos": 124, "sWidth": "100px", "className": "tdheight", "fontfamily": 0, "Id": 0, "RefId": null, "EbObjectType": 0, "ChangeLog": null }, { "$type": "ExpressBase.Objects.Objects.DVRelated.DVNumericColumn, ExpressBase.Objects", "Aggregate": false, "DecimalPlaces": 0, "RenderAs": 0, "LinkRefId": null, "data": 8, "name": "grossamt", "Type": 7, "sTitle": "grossamt", "bVisible": true, "Pos": 124, "sWidth": "100px", "className": "tdheight", "fontfamily": 0, "Id": 0, "RefId": null, "EbObjectType": 0, "ChangeLog": null }, { "$type": "ExpressBase.Objects.Objects.DVRelated.DVNumericColumn, ExpressBase.Objects", "Aggregate": false, "DecimalPlaces": 0, "RenderAs": 0, "LinkRefId": null, "data": 9, "name": "netamt", "Type": 7, "sTitle": "netamt", "bVisible": true, "Pos": 124, "sWidth": "100px", "className": "tdheight", "fontfamily": 0, "Id": 0, "RefId": null, "EbObjectType": 0, "ChangeLog": null }, { "$type": "ExpressBase.Objects.Objects.DVRelated.DVStringColumn, ExpressBase.Objects", "RenderAs": 0, "LinkRefId": null, "data": 10, "name": "submitter", "Type": 16, "sTitle": "submitter", "bVisible": true, "Pos": 124, "sWidth": "100px", "className": "tdheight", "fontfamily": 0, "Id": 0, "RefId": null, "EbObjectType": 0, "ChangeLog": null }, { "$type": "ExpressBase.Objects.Objects.DVRelated.DVStringColumn, ExpressBase.Objects", "RenderAs": 0, "LinkRefId": null, "data": 11, "name": "routegroup", "Type": 16, "sTitle": "routegroup", "bVisible": true, "Pos": 124, "sWidth": "100px", "className": "tdheight", "fontfamily": 0, "Id": 0, "RefId": null, "EbObjectType": 0, "ChangeLog": null }, { "$type": "ExpressBase.Objects.Objects.DVRelated.DVDateTimeColumn, ExpressBase.Objects", "Format": 0, "RenderAs": 0, "LinkRefId": null, "data": 12, "name": "sys_submitted_ts", "Type": 6, "sTitle": "sys_submitted_ts", "bVisible": true, "Pos": 124, "sWidth": "100px", "className": "tdheight", "fontfamily": 0, "Id": 0, "RefId": null, "EbObjectType": 0, "ChangeLog": null }, { "$type": "ExpressBase.Objects.Objects.DVRelated.DVStringColumn, ExpressBase.Objects", "RenderAs": 0, "LinkRefId": null, "data": 13, "name": "modifier", "Type": 16, "sTitle": "modifier", "bVisible": true, "Pos": 124, "sWidth": "100px", "className": "tdheight", "fontfamily": 0, "Id": 0, "RefId": null, "EbObjectType": 0, "ChangeLog": null }, { "$type": "ExpressBase.Objects.Objects.DVRelated.DVDateTimeColumn, ExpressBase.Objects", "Format": 0, "RenderAs": 0, "LinkRefId": null, "data": 14, "name": "sys_last_modified_ts", "Type": 6, "sTitle": "sys_last_modified_ts", "bVisible": true, "Pos": 124, "sWidth": "100px", "className": "tdheight", "fontfamily": 0, "Id": 0, "RefId": null, "EbObjectType": 0, "ChangeLog": null }, { "$type": "ExpressBase.Objects.Objects.DVRelated.DVStringColumn, ExpressBase.Objects", "RenderAs": 0, "LinkRefId": null, "data": 15, "name": "device_id", "Type": 16, "sTitle": "device_id", "bVisible": true, "Pos": 124, "sWidth": "100px", "className": "tdheight", "fontfamily": 0, "Id": 0, "RefId": null, "EbObjectType": 0, "ChangeLog": null }, { "$type": "ExpressBase.Objects.Objects.DVRelated.DVStringColumn, ExpressBase.Objects", "RenderAs": 0, "LinkRefId": null, "data": 16, "name": "forms_id", "Type": 16, "sTitle": "forms_id", "bVisible": true, "Pos": 124, "sWidth": "100px", "className": "tdheight", "fontfamily": 0, "Id": 0, "RefId": null, "EbObjectType": 0, "ChangeLog": null }, { "$type": "ExpressBase.Objects.Objects.DVRelated.DVStringColumn, ExpressBase.Objects", "RenderAs": 0, "LinkRefId": null, "data": 17, "name": "sys_location_id", "Type": 16, "sTitle": "sys_location_id", "bVisible": true, "Pos": 124, "sWidth": "100px", "className": "tdheight", "fontfamily": 0, "Id": 0, "RefId": null, "EbObjectType": 0, "ChangeLog": null }, { "$type": "ExpressBase.Objects.Objects.DVRelated.DVBooleanColumn, ExpressBase.Objects", "IsEditable": false, "RenderAs": 0, "data": 18, "name": "sys_cancelled", "Type": 3, "sTitle": "sys_cancelled", "bVisible": true, "Pos": 124, "sWidth": "100px", "className": "tdheight", "fontfamily": 0, "Id": 0, "RefId": null, "EbObjectType": 0, "ChangeLog": null }, { "$type": "ExpressBase.Objects.Objects.DVRelated.DVBooleanColumn, ExpressBase.Objects", "IsEditable": false, "RenderAs": 0, "data": 19, "name": "sys_locked", "Type": 3, "sTitle": "sys_locked", "bVisible": true, "Pos": 124, "sWidth": "100px", "className": "tdheight", "fontfamily": 0, "Id": 0, "RefId": null, "EbObjectType": 0, "ChangeLog": null }, { "$type": "ExpressBase.Objects.Objects.DVRelated.DVNumericColumn, ExpressBase.Objects", "Aggregate": false, "DecimalPlaces": 0, "RenderAs": 0, "LinkRefId": null, "data": 20, "name": "sys_row_color", "Type": 11, "sTitle": "sys_row_color", "bVisible": true, "Pos": 124, "sWidth": "100px", "className": "tdheight", "fontfamily": 0, "Id": 0, "RefId": null, "EbObjectType": 0, "ChangeLog": null }, { "$type": "ExpressBase.Objects.Objects.DVRelated.DVStringColumn, ExpressBase.Objects", "RenderAs": 0, "LinkRefId": null, "data": 21, "name": "verified", "Type": 16, "sTitle": "verified", "bVisible": true, "Pos": 124, "sWidth": "100px", "className": "tdheight", "fontfamily": 0, "Id": 0, "RefId": null, "EbObjectType": 0, "ChangeLog": null }, { "$type": "ExpressBase.Objects.Objects.DVRelated.DVStringColumn, ExpressBase.Objects", "RenderAs": 0, "LinkRefId": null, "data": 22, "name": "appversion", "Type": 16, "sTitle": "appversion", "bVisible": true, "Pos": 124, "sWidth": "100px", "className": "tdheight", "fontfamily": 0, "Id": 0, "RefId": null, "EbObjectType": 0, "ChangeLog": null }, { "$type": "ExpressBase.Objects.Objects.DVRelated.DVDateTimeColumn, ExpressBase.Objects", "Format": 0, "RenderAs": 0, "LinkRefId": null, "data": 23, "name": "appsubmit_ts", "Type": 6, "sTitle": "appsubmit_ts", "bVisible": true, "Pos": 124, "sWidth": "100px", "className": "tdheight", "fontfamily": 0, "Id": 0, "RefId": null, "EbObjectType": 0, "ChangeLog": null }] }, "Name": "set1_EbTableVisualization0_1", "Id": 0, "RefId": null, "EbObjectType": 0, "ChangeLog": null };



var Eb_PropertyGrid = function (id) {
    this.$wraper = $("#" + id);
    this.wraperId = id;
    this.$controlsDD = $(".controls-dd-cont select");
    this.ctrlsDDCont_Slctr = "#" + this.wraperId + " .controls-dd-cont";
    this.AllObjects = {};
    this.PropsObj = {};
    this.CXVE = {};
    this.$hiddenProps = {};
    this.IsSortByGroup = true;
    this.PropertyChanged = function (obj) { };
    this.DD_onChange = function (e) { };
    this.nameChanged = function (e) { };
    this.Close = function (e) { };

    this.getvaluesFromPG = function () {
        // function that will update and return the values back from the property grid
        for (var prop in this.getValueFuncs) {
            if (typeof this.getValueFuncs[prop] !== 'function') continue;
            this.PropsObj[prop] = ($('#' + this.wraperId + prop).length === 0) ? this.PropsObj[prop] : this.getValueFuncs[prop]();
        }
        return this.PropsObj;
    };

    this.getPropertyRowHtml = function (name, value, meta, options, SubtypeOf) {
        var valueHTML;
        var type = meta.editor || '';
        var elemId = this.wraperId + name;
        var subRow_html = '';
        var subtypeOfAttr = '';
        var req_html = '';
        var NBSP = '';
        var arrow = "&nbsp;";
        var isExpandedAttr = '';
        if (type === 0 || typeof value === 'boolean') {    // If boolean create checkbox
            valueHTML = '<input type="checkbox" id="' + elemId + '" value="' + value + '"' + (value ? ' checked' : '') + ' />';
            if (this.getValueFuncs)
                this.getValueFuncs[name] = function () { return $('#' + elemId).prop('checked'); };
        }
        else if (type === 1) {    // If options create drop-down list
            valueHTML = this.getBootstrapSelectHtml(elemId, value, meta.options);
            this.getValueFuncs[name] = function () { return $('#' + elemId).val(); };
            this.postCreateInitFuncs[name] = function () { $('#' + elemId).parent().find(".selectpicker").selectpicker('val', value); };
        }
        else if (type === 2) {    // If number 
            valueHTML = '<input type="number" id="' + elemId + '" value="' + value + '" style="width:100%" />';
            if (this.getValueFuncs)
                this.getValueFuncs[name] = function () { return ($('#' + elemId).val() === "") ? "" : parseInt($('#' + elemId).val()); };
        }
        else if (type === 3) {    // If color use color picker 
            valueHTML = '<input type="color" id="' + elemId + '" value="' + value + '" style="width:100%; height: 21px;" />';
            this.getValueFuncs[name] = function () { return $('#' + elemId).val(); };
        }
        else if (type === 4) {    // If label (for read-only) span
            valueHTML = '<span style="vertical-align: sub;" for="' + elemId + '" editor="' + type + '">' + value + '</span>';
        }
        else if (type === 5) {    //  If string editor textbox
            valueHTML = '<input type="text" id="' + elemId + '" value="' + value + '"style="width:100%"></div>';
            this.getValueFuncs[name] = function () { return $('#' + elemId).val(); };
        }
        else if (type === 6) {    //  If date&time date
            valueHTML = '<input type="date" id="' + elemId + '" value="' + value + '"style="width:100%"></div>';
            this.getValueFuncs[name] = function () { return $('#' + elemId).val(); };
        }
        else if (type > 6 && type < 11) {    //  If collection editor
            valueHTML = '<span style="vertical-align: sub;">(Collection)</span>'
                + '<button for="' + name + '" editor= "' + type + '" class= "pgCX-Editor-Btn" >... </button> ';
        }
        else if (type === 11) {    // If JS editor
            valueHTML = '<span style="vertical-align: sub;">(JavaScript)</span>'
                + '<button for="' + name + '" editor= "' + type + '" class= "pgCX-Editor-Btn" >... </button> ';
        }
        else if (type === 12) {    // SQL editor
            valueHTML = '<span style="vertical-align: sub;">(SQL)</span>'
                + '<button for="' + name + '" editor= "' + type + '" class= "pgCX-Editor-Btn" >... </button> ';
        }
        else if (type === 13) {  //  If Object Selector editor
            valueHTML = '<input type="text" id="' + elemId + '" for="' + name + '" value="' + value + '" readonly style=" width: calc(100% - 26px); direction: rtl;" />'
                + '<button for="' + name + '" editor= "' + type + '" class= "pgCX-Editor-Btn" >... </button> ';
        }
        else if (type === 15) {  //  If expandable
            valueHTML = '<input type="text" for="' + name + '" readonly value="' + this.getExpandedValue(value) + '" style="width:100%; direction: rtl;" />';
            valueHTML += "<input type='hidden' value='" + JSON.stringify(value) + "' id='" + elemId + "'>";
            var subRow_html = "";
            var _meta = meta.submeta;
            var _obj = value;
            arrow = '<i class="fa fa-caret-right" aria-hidden="true"></i>';
            isExpandedAttr = 'is-expanded="true"';
            $.each(_obj, function (key, val) {
                var CurMeta = getObjByval(_meta, "name", key);
                if (CurMeta)
                    subRow_html += this.getPropertyRowHtml(key, val, CurMeta, CurMeta.options, name);
            }.bind(this));
            var $subRows = $("#" + this.wraperId + " [subtype-of=" + name + "]");
            this.getValueFuncs[name] = function () {
                var $subRows = $("#" + this.wraperId + " [subtype-of=" + name + "]");
                $.each($subRows, function (i, row) {
                    var key = $(row).attr("name").slice(0, -2);
                    var val = $(row).find(".pgTdval input").val();
                    value[key] = val;
                });
                $('#' + elemId).val(JSON.stringify(value)).siblings().val(this.getExpandedValue(value));
                return JSON.parse($('#' + elemId).val());
            }.bind(this);
        } else {    // Default is textbox
            valueHTML = 'editor Not implemented';
        }
        if (meta.OnChangeExec)
            this.OnChangeExec[name] = meta.OnChangeExec;
        if (SubtypeOf) {
            NBSP = "&nbsp;&nbsp;&nbsp;";
            subtypeOfAttr = 'subtype-of="' + SubtypeOf + '"';
        }
        if (meta.IsRequired)
            req_html = '<sup style="color: red">*</sup>';

        return '<tr class="pgRow" ' + subtypeOfAttr + isExpandedAttr + ' name="' + name + 'Tr" group="' + this.currGroup + '"><td class="pgTdName" data-toggle="tooltip" data-placement="left" title="' + meta.helpText + '">' + arrow + NBSP + (meta.alias || name) + req_html + '</td><td class="pgTdval">' + valueHTML + '</td></tr>' + subRow_html;
    };

    this.getExpandedValue = function (obj) {
        values = [];
        $.each(obj, function (key, val) {
            if (key !== "$type")
                values.push(val);
        });
        return values;
    };

    this.getBootstrapSelectHtml = function (id, selectedValue, options) {
        selectedValue = selectedValue || options[0];
        var html = "<select class='selectpicker' >";
        for (var i = 0; i < options.length; i++)
            html += "<option data-tokens='" + options[i] + "'>" + options[i] + "</option>";
        html += "</select><input type='hidden' value='" + selectedValue + "' id='" + id + "'>";
        return html;
    };

    this.getGroupHeaderRowHtml = function (displayName) {
        if (this.IsSortByGroup)
            return '<tr class="pgGroupRow" is-expanded="true" group-h="' + displayName + '"><td colspan="2" class="pgGroupCell">'
                + '<span class="bs-caret" style= "margin-right: 5px;" > <span class="caret"></span></span > ' + displayName
                + '</td></tr > ';
        else
            return '<tr class="pgGroupRow" group-h="' + displayName + '"><td colspan="2" class="pgGroupCell"> &nbsp ' + displayName + '</td></tr > ';
    };

    this.isContains = function (obj, val) {
        for (var i = 0; i < obj.length; i++)
            if (obj[i].name.toLowerCase() === val.toLowerCase())
                return true;
        return false;
    };

    this.CallpostInitFns = function () {
        // Call the post init functions 
        for (var prop in this.postCreateInitFuncs) {
            if (typeof this.postCreateInitFuncs[prop] === 'function') {
                this.postCreateInitFuncs[prop]();
                this.postCreateInitFuncs[prop] = null;// just in case make sure we are not holding any reference to the functions
            }
        }
        // call OnChangeExec functions
        for (var prop in this.OnChangeExec) {
            var func = this.OnChangeExec[prop].bind(this.PropsObj, this);
            $("#" + this.wraperId + " [name=" + prop + "Tr]").on("change", "input, select", func);
            func();
        }
    };

    this.MakeReadOnly = function (prop) { $("#" + this.wraperId + " [name=" + prop + "Tr]").find("input").prop("readonly", true); };

    this.MakeReadWrite = function (prop) { $("#" + this.wraperId + " [name=" + prop + "Tr]").find("input").prop("readonly", false); };

    this.HideProperty = function (prop) {
        if (this.$hiddenProps[prop])
            return;
        var $Tr = $("#" + this.wraperId + " [name=" + prop + "Tr]");
        this.$hiddenProps[prop] = { "$Tr": $Tr, "g": $Tr.attr("group") };
        $Tr.remove();
    };

    this.ShowProperty = function (prop) {
        if (!this.$hiddenProps[prop])
            return;
        var $Tr = this.$hiddenProps[prop].$Tr;
        var g = this.$hiddenProps[prop].g;
        $Tr.insertAfter($("#" + this.wraperId + " [group-h=" + g + "]"));
        this.$hiddenProps[prop] = null;
    };

    this.buildGrid = function () {
        // Now we have all the html we need, just assemble it
        for (var group in this.groupsHeaderRowHTML) {
            // Add the group row
            this.innerHTML += this.groupsHeaderRowHTML[group];
            // Add the group cells
            this.innerHTML += this.propertyRowsHTML[group];
        }
        // Finally we add the 'Other' group (if we have something there)
        if (this.propertyRowsHTML[this.MISC_GROUP_NAME]) {
            this.innerHTML += this.getGroupHeaderRowHtml(this.MISC_GROUP_NAME);
            this.innerHTML += this.propertyRowsHTML[this.MISC_GROUP_NAME];
        }
        // Close the table and apply it to the div
        this.$PGcontainer.html(this.innerHTML);
        $("#" + id + ' .selectpicker').on('change', function (e) { $(this).parent().siblings("input").val($(this).find("option:selected").val()); });
    };

    this.buildRows = function () {
        var propArray = [];
        for (var prop in this.PropsObj) { propArray.push(prop); }
        propArray.sort();
        var prop = null;
        for (var i in propArray) {
            prop = propArray[i];
            // Skip if this is not a direct property, a function, or its meta says it's non browsable
            if (!this.PropsObj.hasOwnProperty(prop) || typeof this.PropsObj[prop] === 'function' || !this.isContains(this.Metas, prop))
                continue;
            if (this.IsSortByGroup) {
                // Check what is the group of the current property or use the default 'Other' group
                this.currGroup = (this.Metas[this.propNames.indexOf(prop.toLowerCase())]).group || this.MISC_GROUP_NAME;
            }
            else
                this.currGroup = "All";

            // If this is the first time we run into this group create the group row
            if (this.currGroup !== this.MISC_GROUP_NAME && !this.groupsHeaderRowHTML[this.currGroup])
                this.groupsHeaderRowHTML[this.currGroup] = this.getGroupHeaderRowHtml(this.currGroup);

            // Initialize the group cells html
            this.propertyRowsHTML[this.currGroup] = this.propertyRowsHTML[this.currGroup] || '';

            // Append the current cell html into the group html
            this.propertyRowsHTML[this.currGroup] += this.getPropertyRowHtml(prop, this.PropsObj[prop], this.Metas[this.propNames.indexOf(prop.toLowerCase())], (this.Metas[this.propNames.indexOf(prop.toLowerCase())]).options);

        }
    };

    this.OnInputchangedFn = function (e) {
        this.getvaluesFromPG();
        if (e)
            this.CurProp = $(e.target).closest("tr").attr("name").slice(0, -2);;
        var res = this.getvaluesFromPG();
        $('#txtValues').val(JSON.stringify(res) + '\n\n');
        this.PropertyChanged(this.PropsObj, this.CurProp);

        if (this.PropsObj.RenderMe)
            this.PropsObj.RenderMe();

        console.log("col :\n\n" + JSON.stringify(res) + '\n\n');
    };

    this.addToDD = function (obj) {
        var $MainCtrlsDDCont = $(("#" + this.wraperId).replace(/_InnerPG/g, "")).children(".controls-dd-cont");
        var _name = (obj.Name || obj.name);
        if ($(".pgCXEditor-bg").css("display") !== "none") {
            if ($(".pgCXEditor-Cont #SelOpt" + obj.EbSid + this.wraperId).length === 0) { // need rework
                $(this.ctrlsDDCont_Slctr + " select").append("<option data-name = '" + _name + "'id='SelOpt" + _name + this.wraperId + "'>" + _name + "</option>");
                $(this.ctrlsDDCont_Slctr + " .selectpicker").selectpicker('refresh');
            }
        }
        if ($MainCtrlsDDCont.find("[data-name=" + obj.EbSid + "]").length === 0) {
            $MainCtrlsDDCont.find("select").append("<option data-name = '" + _name + "'id='M_SelOpt" + _name + this.wraperId + "'>" + _name + "</option>");
            $MainCtrlsDDCont.find(".selectpicker").selectpicker('refresh');
        }
        $(this.ctrlsDDCont_Slctr + " .selectpicker").selectpicker('val', _name);
    };

    this.removeFromDD = function (EbSid) {
        var slctr = EbSid + this.wraperId;
        if ($(".pgCXEditor-bg").css("display") !== "none")
            slctr = slctr + "_InnerPG";
        if ($("#M_SelOpt" + slctr))
            $("#M_SelOpt" + slctr).remove();
        if ($("#SelOpt" + slctr))
            $("#SelOpt" + slctr).remove();
        $(".controls-dd-cont" + " .selectpicker").selectpicker('refresh');
    };

    this.CloseFn = function (e) {
        alert();
        this.Close();
    };

    this.init = function () {
        this.$wraper.empty().addClass("pg-wraper");
        this.$wraper.append($('<div class="pgHead"><div name="sort" class="icon-cont pull-left"> <i class="fa fa-sort-alpha-asc" aria-hidden="true"></i></div><div name="sort" class="icon-cont pull-left"> <i class="fa fa-list-ul" aria-hidden="true"></i></div>Properties <div class="icon-cont  pull-right"  onclick="slideRight(\'.form-save-wraper\', \'#form-buider-propGrid\')"><i class="fa fa-times" aria-hidden="true"></i></div></div> <div class="controls-dd-cont"> <select class="selectpicker" data-live-search="true"> </select> </div>'));
        this.$wraper.append($("<div id='" + this.wraperId + "_propGrid' class='propgrid-table-cont'></div>"));
        this.$PGcontainer = $("#" + this.wraperId + "_propGrid");
        $(this.ctrlsDDCont_Slctr + " .selectpicker").on('change', this.ctrlsDD_onchange.bind(this));
        $("#" + this.wraperId + " .pgHead").on("click", ".fa-times", this.CloseFn.bind(this));

        this.CXVE = new Eb_pgCXVE(this);

        $("#" + this.wraperId + " .pgHead").on("click", "[name=sort]", this.SortFn.bind(this));
        $("#" + this.wraperId + " [name=sort]:eq(1)").hide();
    };

    this.ctrlsDD_onchange = function (e) {
        var SelItem = $(e.target).find("option:selected").attr("data-name");
        $("#" + SelItem).focus();
        SelObj = this.AllObjects[SelItem];
        var type = SelObj.$type.split(",")[0].split(".")[2];
        this.setObject(SelObj, AllMetas[type]);
        this.DD_onChange(e);
    };

    this.SortFn = function (e) {
        this.IsSortByGroup = !this.IsSortByGroup;
        this.InitPG();
        $("#" + this.wraperId + " [name=sort]").toggle();
    };

    this.InitPG = function () {
        this.propNames = [];
        this.MISC_GROUP_NAME = 'Miscellaneous';
        this.GET_VALS_FUNC_KEY = 'pg.getValues';
        this.propertyRowsHTML = { 'Misc': '' };
        this.groupsHeaderRowHTML = {};
        this.postCreateInitFuncs = {};
        this.OnChangeExec = {};
        this.getValueFuncs = {};
        this.currGroup = null;
        this.CurProp = null;
        this.CurEditor = null;
        this.OSElist = {};
        this.innerHTML = '<table class="table-bordered table-hover pg-table">';
        this.$PGcontainer.empty();
        for (var i = 0; i < this.Metas.length; i++)
            this.propNames.push(this.Metas[i].name.toLowerCase());

        this.buildRows();
        this.buildGrid();
        this.CallpostInitFns();
        this.getvaluesFromPG();//no need

        $("#" + this.wraperId + " .propgrid-table-cont .selectpicker").on('changed.bs.select', this.OnInputchangedFn.bind(this));
        $('#' + this.wraperId + "_propGrid" + ' table td').find("input").change(this.OnInputchangedFn.bind(this));
        $('#' + this.wraperId + "_propGrid" + ' table tr').find(".fa-caret-right").click(this.ExpandToggle.bind(this));
        this.addToDD(this.PropsObj);
        if (this.PropsObj.RenderMe)
            this.PropsObj.RenderMe();
        $("#" + this.wraperId + " .pgCX-Editor-Btn").on("click", this.CXVE.pgCXE_BtnClicked.bind(this.CXVE));
        $("#" + this.wraperId + " .pgRow:contains(Name)").find("input").on("change", this.nameChangedFn);
        $("#" + this.wraperId + " .pgGroupCell").on("click", this.collapsGroup);
    };

    this.collapsGroup = function (e) {
        var $GroupHeadRow = $(e.target).closest("[group-h]");
        var isExpanded = $GroupHeadRow.attr("is-expanded") === 'true';
        var groupName = $GroupHeadRow.attr("group-h");
        var $groupRows = $("#" + this.wraperId + " [group=" + groupName + "]");
        if (groupName !== "All") {
            if (isExpanded) {
                $("#" + this.wraperId + " [group=" + groupName + "]").filter("[subtype-of]").hide(200);
                $groupRows.hide();
            }
            else {
                $groupRows.show();
                $("#" + this.wraperId + " [group=" + groupName + "]").filter("[is-expanded]").find(".fa-caret-right").click().click();
            }
        }
        $GroupHeadRow.attr("is-expanded", !isExpanded);

    }.bind(this);

    this.ExpandToggle = function (e) {
        var t = 0;
        if (e.hasOwnProperty('originalEvent'))
            var t = 200;
        var $parentPropRow = $(e.target).closest("tr");
        var isExpanded = $parentPropRow.attr("is-expanded") === 'true';
        var subtype = $parentPropRow.attr("name").slice(0, -2);
        if (isExpanded)
            $("#" + this.wraperId + " [subtype-of=" + subtype + "]").hide(t);
        else
            $("#" + this.wraperId + " [subtype-of=" + subtype + "]").show(t);
        $parentPropRow.attr("is-expanded", !isExpanded);
    };

    this.nameChangedFn = function (e) {
        var name = e.target.value;
        $("#M_SelOpt" + this.PropsObj.EbSid + this.wraperId).text(name);
        $("#SelOpt" + this.PropsObj.EbSid + this.wraperId).text(name);

        $("#" + this.PropsObj.EbSid + ' span').text(name);

        $(".controls-dd-cont" + " .selectpicker").selectpicker('refresh');
        this.nameChanged();
    }.bind(this)

    this.clear = function () {
        this.$PGcontainer.empty();
    };

    this.setObject = function (props, metas) {
        //params check
        {
            if (typeof props === 'string' || typeof metas === 'string') {
                console.error('Eb_PropertyGrid got "string" parameter instead of "object"');
                return null;
            } else if (typeof id === 'object') {
                console.error('Eb_PropertyGrid got "object" parameter instead of "string"');
                return;
            } else if (typeof props !== 'object' || props === null || typeof metas !== 'object' || metas === null) {
                console.error('Eb_PropertyGrid must get an object in order to initialize the grid.');
                return;
            }
        }
        this.Metas = metas;
        this.PropsObj = props;
        this.AllObjects[this.PropsObj.EbSid] = this.PropsObj;
        this.InitPG();
    };
    this.init();
};