@using ServiceStack;
@using ExpressBase.Objects;
@using ExpressBase.Common;
@using Newtonsoft.Json;
@using ExpressBase.Objects.ServiceStack_Artifacts;
@using ExpressBase.Common.Objects;
@{
    Layout = "~/Views/Shared/_Layout1.cshtml";
}
<link rel="stylesheet" type="text/css" href="~/css/splitWindow.css">
<script src="~/js/splitWindow.js" type="text/javascript"></script>
<style>
    .scrollable-menu {
        height: auto;
        max-height: 200px;
        overflow-x: visible;
        overflow-y: scroll;
    }

    .loadingdiv {
        vertical-align: middle;
        margin: 5% 50%;
        z-index: 1;
        display: none;
    }

    .tools {
        border: none;
        background: none;
        color: black;
    }
</style>
@{
    string head = string.Empty;
    string html = string.Empty;

    var dvRefId = ViewBag.dvRefId;
    var dvobj = EbSerializers.Json_Serialize(ViewBag.dvObject);
}
<div class="row" style="margin-top: 52px;">
    <div class="toolbar-com" id='Toolbar'>
            @*<button id='first' class='tools commonControls' style="display:none"><i class="fa fa-step-backward fa-lg" style="margin-bottom: 11px;" aria-hidden="true"></i></button>
            <button id='prev' class='tools commonControls' style="display:none"><i class="fa fa-caret-left fa-lg" aria-hidden="true"></i></button>
            <button id='next' class='tools commonControls' style="display:none"><i class="fa fa-caret-right fa-lg" aria-hidden="true"></i></button>
            <button id='last' class='tools commonControls' style="display:none"><i class="fa fa-step-forward fa-lg" style="margin-bottom: 11px;" aria-hidden="true"></i></button>*@
            <button id='dvMenu' class='tools commonControls'><i class="fa fa-bars" aria-hidden="true"></i></button>
            <label class='dvname commonControls' style='color: #333;width:100px'></label>
            <button id='btnGo' class='tools commonControls' style='display:none'><i class="fa fa-play" aria-hidden="true"></i></button>
            <button id='Save_btn' class='tools commonControls' style='display:none'>Save</button>
            <button id='fd_toggle' class='tools commonControls' style="display:none">Toggle</button>
            <button id='Settings' class='tools commonControls' style="display:none"><i class="fa fa-cog" aria-hidden="true"></i></button>
            @*<div class='dropdown tools commonControls' id='Relateddvtable' style='display: inline-block;padding-top: 1px;'>
                <button class='tools dropdown-toggle' type='button' data-toggle='dropdown'>
                    <span class='caret'></span>
                </button>
                <ul class='dropdown-menu'>
                    <li><a href='#' data-id='660' objtype='16'><i class='fa fa-line-chart custom'></i> Table1</a></li>
                    <li><a href='#' data-id='663' objtype='17'><i class='fa fa-bar-chart custom'></i> Chart </a></li>
                </ul>
            </div>*@
    </div>
</div>

<div class="row" id="parent-div">
    <div class="col-md-12 no-padd cont-wnd" id="contBox">
        <div class="row">
            <div class="col-md-2">
                <div class="no-padd pull-right" id="ppgrid">
                </div>
            </div>
        </div>
     </div>
    
</div>


@section EbHead {
    <script>
        var counter = 0;
        @Html.Raw(ViewBag.EbObjectType)
        @Html.Raw(ViewBag.Meta)
        @Html.Raw(ViewBag.JsObjects);

        var Wcount = 0, ObjCount = 0;
        var dvcontainerObj = new DvContainerObj({
            ss_url: '@ViewBag.ServiceUrl',
            wc:'@ViewBag.wc'

        });
        var split = new splitWindow("parent-div", "contBox");

        split.windowOnFocus = function (ev) {
            if ($(ev.target).attr("class").indexOf("sub-windows") !== -1) {
                var id = $(ev.target).attr("id");
                focusedId = id;
                var type = $(ev.target).attr("eb-type");
                var dvobj = dvcontainerObj.dvcol[id];
                pg.setObject(dvobj, AllMetas[type]);
            }
        }

        var pg = new Eb_PropertyGrid("ppgrid");
        var dvJsObj = @Html.Raw(dvobj);
        $("label.dvname").text(dvJsObj.Name);
        if ('@ViewBag.dvObject'.indexOf("EbTableVisualization") !== -1) {
            pg.setObject(dvJsObj, AllMetas["EbTableVisualization"]);
            split.createContentWindow(dvJsObj.EbSid + "_" + ++counter, "EbTableVisualization");
            call2dvView(dvJsObj);
        }
        else if ('@ViewBag.dvObject'.indexOf("EbChartVisualization") !== -1) {
            pg.setObject(dvJsObj, AllMetas["EbChartVisualization"]);
            split.createContentWindow(dvJsObj.EbSid + "_" + ++counter, "EbChartVisualization");
            call2dvView(dvJsObj);
        }



        pg.PropertyChanged = function (obj, Pname) {
            //if (Pname == "Visualizations") {
            //    if (obj[Pname] !== null) {
            //        $.each(obj[Pname], function (i, dv) {
            //            if ($("#contBox").children("#sub_window_dv" + dv.EbSid).length == 0) {
            //                if (dv.$type.indexOf("EbTableVisualization") !== -1) {
            //                    split.createContentWindow(dv.EbSid, "EbTableVisualization");
            //                    dvcontainerObj.dvcol["sub_window_dv" + dv.EbSid] = (new EbObjects["EbTableVisualization"](dv.EbSid));
            //                    ObjCount++;
            //                }
            //                else if (dv.$type.indexOf("EbChartVisualization") !== -1) {
            //                    split.createContentWindow(dv.EbSid, "EbChartVisualization");
            //                    dvcontainerObj.dvcol["sub_window_dv" + dv.EbSid] = (new EbObjects["EbChartVisualization"](dv.EbSid));
            //                    ObjCount++;
            //                }
            //            }
            //        });
            //    }
            //    if ($("#contBox").children().length >= 2) {
            //        $("#prev").css("display", "inline-block");
            //        $("#next").css("display", "inline-block");
            //        if ($("#contBox").children().length > 2) {
            //            $("#first").css("display", "inline-block");
            //            $("#last").css("display", "inline-block");
            //        }
            //    }
            //    //$.each(dvcontainerObj.dvcol, function (key, value) {
            //    //    focusedId = key;
            //    //    return false;
            //    //});
            //    //$("#" + focusedId).focus();
            //}
            //else
            if (Pname == "DataSourceRefId") {
                if (obj[Pname] !== null) {
                    call2dvView(obj);
                    //$("#sub_windows_sidediv_dv" + obj.EbSid).load("../DV/dvCommon", { dvobj:JSON.stringify(obj), dvRefId: null }, function () {
                    //    $.LoadingOverlay("hide");
                    //    $("#btnGo").css("display", "inline-block");
                    //    dvcontainerObj.dvcol["sub_window_dv" + obj.EbSid] = dvcontainerObj.currentObj;
                    //});
                }
            }
            else if (Pname == "Name") {
                dvcontainerObj.currentObj = obj;
                $("label.dvname").text(obj.Name);
            }
        }

        function call2dvView(obj) {
            dvcontainerObj.currentObj = obj;
            $.LoadingOverlay("show");
            $.ajax({
                type: "POST",
                url: "../DV/dvCommon",
                data: { dvobj: JSON.stringify(obj), dvRefId: null },
                success: function (text) {
                    var subDivId = $("#sub_window_dv" + obj.EbSid + "_" + counter);
                    var sideDivId = $("#sub_windows_sidediv_dv" + obj.EbSid + "_" + counter);
                    $("#ppgrid").parent().css("display", "none");
                    $(subDivId.children()[2]).removeClass("col-md-10").addClass("col-md-12");
                    if (text.indexOf("filterBox") === -1) {
                        sideDivId.css("display", "none");
                        $("#fd_toggle").css("display", "none");
                        $.LoadingOverlay("hide");
                        dvcontainerObj.dvcol["sub_window_dv" + obj.EbSid + "_" + counter] = dvcontainerObj.currentObj;
                        $(subDivId.children()[2]).removeClass("col-md-10").addClass("col-md-12");
                    }
                    else {
                        sideDivId.children().remove();
                        sideDivId.append(text);
                        $.LoadingOverlay("hide");
                        $("#btnGo").css("display", "inline-block");
                        dvcontainerObj.dvcol["sub_window_dv" + obj.EbSid + "_" + counter] = dvcontainerObj.currentObj;
                        if (getVisCount() > 1) {
                            if (dvcontainerObj.currentObj.$type.indexOf("EbTableVisualization") !== -1) {
                                sideDivId.css("display", "inline");
                                $(subDivId.children()[2]).removeClass("col-md-12").addClass("col-md-10");
                            }
                            else {
                                sideDivId.css("display", "none");
                                $(subDivId.children()[2]).removeClass("col-md-10").addClass("col-md-12");
                            }
                        }
                        else {
                            sideDivId.css("display", "inline");
                            $(subDivId.children()[2]).removeClass("col-md-12").addClass("col-md-10");
                        }
                    }
                    $("#sub_window_dv" + obj.EbSid + "_" + counter).focus();
                    if ($("#contBox").children().length >= 2) {
                        $("#prev").css("display", "inline-block");
                        $("#next").css("display", "inline-block");
                        if ($("#contBox").children().length > 2) {
                                $("#first").css("display", "inline-block");
                                $("#last").css("display", "inline-block");
                        }
                    }
                }
            });
        }

        function getVisCount() {
            var i = 0;
            $.each(dvcontainerObj.dvcol, function () {
                i++;
            });
            return i;
        }
        

        //function drawDv(e) {
        //    $.LoadingOverlay("show");
        //    $.ajax({
        //        type: "POST",
        //        url: "../DV/getdv",
        //        data: { id: $(e.target).attr("data-id"), objtype: $(e.target).attr("objtype") },
        //        success: function (dvobj) {
        //            $("#contBox").append(text);
        //            $.LoadingOverlay("hide");
        //        }
        //    });

        //}

        $(document).ready(function () {
            @Html.Raw(head)
            $('[data-toggle="tooltip"]').tooltip();
        });
    </script>
}
