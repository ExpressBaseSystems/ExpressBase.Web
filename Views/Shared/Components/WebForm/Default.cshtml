@{
    Layout = "~/Views/Shared/LayoutInner.cshtml";
}
@using ExpressBase.Objects;
@{
    var bApnd = true;
    if (ViewBag.Env == "Development")
    {
        bApnd = false;
    }
}
@*
    For more information on enabling MVC for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860
*@

@* BOOTSTRAP CSS *@

<link rel="stylesheet" type="text/css" href="~/css/FormBuiderStyles.css" asp-append-version=@bApnd />
<link rel="stylesheet" type="text/css" href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css">
<link rel="stylesheet" type="text/css" href="~/css/jquery.datetimepicker.css">
<link href="https://rawgit.com/KidSysco/jquery-ui-month-picker/v3.0.0/demo/MonthPicker.min.css" rel="stylesheet" type="text/css" />
<link rel="stylesheet" type="text/css" href="~/css/datatables.min.css" asp-append-version=@bApnd />
<link rel="stylesheet" type="text/css" href="~/css/Eb.css" asp-append-version=@bApnd />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.5/css/bootstrap-select.css">
<link rel="stylesheet" type="text/css" href="~/css/bootstrap-multiselect.css" asp-append-version=@bApnd />@*amal*@
<link rel="stylesheet" type="text/css" href="~/css/Eb_datatable.css" asp-append-version=@bApnd />


<script type="text/javascript" src="~/js/jQuery Mask Plugin v1.14.9.js" asp-append-version=@bApnd></script>
<script type="text/javascript" src="~/js/jquery.datetimepicker.min.js" asp-append-version=@bApnd></script>
<script type="text/javascript" src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>
<script type="text/javascript" src="~/js/datatables.min.js" asp-append-version=@bApnd></script>
<script src="~/js/Eb_Basic_DataTable.js" asp-append-version=@bApnd></script>
<script src="https://rawgit.com/KidSysco/jquery-ui-month-picker/v3.0.0/demo/MonthPicker.min.js"></script>
<script type="text/javascript" src="~/js/FormBuilder/WebFormRenderer.js" asp-append-version=@bApnd></script>
<script type="text/javascript" src="~/js/FormBuilder/FormRenderCommon.js" asp-append-version=@bApnd></script>
<script type="text/javascript" src="~/js/Eb_select.js" asp-append-version=@bApnd></script>
<script type="text/javascript" src="~/js/Eb_UtilityFuncions.js" asp-append-version=@bApnd></script>@*jith*@
<script type="text/javascript" src="~/js/EbControls/EbDataGrid.js" asp-append-version=@bApnd></script>@*jith*@
<script type="text/javascript" src="~/js/FormBuilder/InitFormControls.js" asp-append-version=@bApnd></script>@*jith*@
<script type="text/javascript" src="~/js/FormBuilder/DGUCcolumn.js" asp-append-version=@bApnd></script>@*jith*@
<script type="text/javascript" src="~/js/FormBuilder/EbControlCollection.js" asp-append-version=@bApnd></script>@*jith*@
<script type="text/javascript" src="~/js/jquery.inputmask.bundle.js" asp-append-version=@bApnd></script>@*jith*@
<script type="text/javascript" src="~/js/vue-select.js" asp-append-version=@bApnd></script>
<script type="text/javascript" src="https://unpkg.com/vue@2.1.10"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.5/js/bootstrap-select.js"></script>
<script type="text/javascript" src="~/js/bootstrap-multiselect.js" asp-append-version=@bApnd></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.17.1/moment.min.js"></script>

@{

    EbToolbox _toolBox = new EbToolbox(ExpressBase.Common.Objects.BuilderType.WebForm);
    //ivide
    <script>
    @Html.Raw(_toolBox.EbOnChangeUIfns);
    @Html.Raw(_toolBox.AllMetas);
    @Html.Raw(_toolBox.AllControlls);
    </script>
}


<script>
    @Html.Raw(ViewBag.HtmlHead);
</script>

<style>
    .webform-cont {
        /*margin-top: 38px;
        height: calc(100vh - 38px);*/
        margin-left: -15px;
        width: calc(100% + 30px);
    }

    .form-buider-form {
        height: 100vh;
        padding: 38px 10px 0px 10px;
        border: none;
    }

    .Eb-ctrlContainer .input-group-addon {
        border-radius: 0;
    }

    .save-cont {
        text-align: center;
    }

    .webform-save {
        /*background-color: #2827a0;
        border: none;
        padding: 3px 11px;
        color: white;
        box-shadow: -2px 2px 3px 0 #00000059;
        border-radius: 2px;*/
    }

    .form-render-table > tbody > tr > td {
        border: none !important;
    }

    .form-buider-form .Eb-ctrlContainer {
        min-height: 20px;
    }

    .radiog-cont {
        border: none;
        border-radius: 5px;
    }

    .form-buider-form .Eb-ctrlContainer table td {
        /*background: #fff;*/
        padding: 0px 2px;
    }

    .fmode {
        color: #fff;
        font-weight: normal;
        border-radius: 10px;
        font-weight: normal;
        margin-left: 3px;
        padding: 1px 6px;
        background-color: #9bf052;
    }

        .fmode[mode="New Mode"] {
            background-color: #00d036;
        }

        .fmode[mode="Edit Mode"] {
            background-color: #f09b52;
        }

        .fmode[mode="View Mode"] {
            background-color: #222222;
        }

    /*#divAuditTrail tbody {
        max-height: calc(100vh - 225px);
        overflow-y: auto;
        width: 100%;
    }

    #divAuditTrail thead, #divAuditTrail tbody, #divAuditTrail tr, #divAuditTrail td, #divAuditTrail th {
        display: block;
    }

    #divAuditTrail tbody td {
        float: left;
    }

    #divAuditTrail thead tr th {
        float: left;
    }*/
    #divAuditTrail .trans-title-tr th {
        background-color: darkcyan;
        color: white;
    }
    #divAuditTrail .table-title-tr th {
        padding: 4px 8px;
        background-color: #ddd;
    }
    #divAuditTrail .second-table tr:nth-child(even) {
        background-color: #f2f2f2;
    }

    #divAuditTrail .second-table tr:hover, #divAuditTrail .first-table tr:hover {
        background-color: #ddd;
    }

</style>

<div id='WebForm-cont' class="webform-cont">
    @Html.Raw(ViewBag.WebFormHtml)
    <div class="save-cont"></div>
</div>

<div class="modal fade" id="AuditHistoryModal" role="dialog">
    <div class="modal-dialog" style="width: 60%;">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Audit History</h4>
            </div>
            <div class="modal-body" style="height:calc(100vh - 190px); overflow: auto; padding: 0px;">
                <div id="divAuditTrail" style="height: inherit;"> </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    @Html.Raw(ViewBag.ControlOperations);

    let header = new EbHeader();
    header.insertButton(`<button id="webformdelete" class='btn' title='Delete'><i class="fa fa-trash" aria-hidden="true"></i></button>`);
    header.insertButton(`<button id="webformcancel" class='btn' title='Cancel'><i class="fa fa-ban" aria-hidden="true"></i></button>`);
    header.insertButton('<button id="webformnew" class="btn" onclick="window.location.href = window.location.href" title="New form"><i class="fa fa-plus" aria-hidden="true"></i></button>');
    header.insertButton(`<button id="webformedit" class='btn' title='Edit'><i class="fa fa-pencil" aria-hidden="true"></i></button>`);
    header.insertButton('<button id="webformsave" class="btn" title="Save form"><i class="fa fa-save" aria-hidden="true"></i></button>');
    header.insertButton('<button id="webformaudittrail" class="btn" title="Audit Trail"><i class="fa fa-history" aria-hidden="true"></i></button>')

    //header.insertButton(' <button class="btn" id="webformsave"  title="Save form"><i class="fa fa-save" aria-hidden="true"></i></button>');
    //let _editModeObj =  '@Html.Raw(ViewBag.editModeObj)';

    let _formRefId = "@Html.Raw(ViewBag.formRefId)";
    let _formObj = @Html.Raw(ViewBag.WebFormObj);
    let _rowId = @Html.Raw(ViewBag.rowId);
    let _formData =  @Html.Raw(ViewBag.formData);
    let _userObject =  @Html.Raw(ViewBag.userObject);
    let _mode = "@Html.Raw(ViewBag.Mode)";
    let _cid = "@ViewBag.Cid";
    let _env = "@ViewBag.Env";

    //to store refids of uploaded files via all fileuploader ctrls
    let uploadedFileRefList = {};

    function setHeader(reqstMode) {
        _mode = reqstMode;//
        //reqstMode = "Edit Mode" or "New Mode" or "View Mode"
        if (reqstMode === "Edit Mode") {
            header.showElement(["webformnew", "webformsave", "webformaudittrail"]);
            header.hideElement(["webformedit", "webformdelete", "webformcancel"]);
        }
        else if (reqstMode === "New Mode") {
            header.showElement(["webformsave"]);
            header.hideElement(["webformnew", "webformedit", "webformdelete", "webformcancel", "webformaudittrail"]);
        }
        else if (reqstMode === "View Mode") {
            header.showElement(["webformnew", "webformedit", "webformdelete", "webformcancel", "webformaudittrail"]);
            header.hideElement(["webformsave"]);
        }
        else if (reqstMode === "Fail Mode") {
            header.hideElement(["webformsave", "webformnew", "webformedit", "webformdelete", "webformcancel", "webformaudittrail"]);
            EbMessage("show", { Message: 'Data Not Found!', AutoHide: false, Background: '#aa0000' });
        }
        else if (reqstMode === "Preview Mode") {
            header.hideElement(["webformnew", "webformedit", "webformdelete", "webformsave", "webformcancel", "webformaudittrail"]);
            _mode = "New Mode";////////////
        }
        header.setName(_formObj.DisplayName);
        header.setMode(`<span mode="${reqstMode}" class="fmode">${reqstMode}</span>`);
        $('title').text(_formObj.DisplayName + `(${reqstMode})`);
    }
    setHeader(_mode);

    //let _$saveBtn = $("#webformsave");
    //let FormMode = "New Mode";

    const renderer = new WebFormRender({
        formObj: _formObj,
        headerBtns: { New: "webformnew", Edit: "webformedit", Save: "webformsave", Delete: "webformdelete", Cancel: "webformcancel"},
        formRefId: _formRefId,
        mode: _mode,
        rowId: _rowId,
        formData: _formData,
        userObject: _userObject,
        cid: _cid,
        env: _env
    });

    //if (_editModeObj === "false") {
    //    _editModeObj = false;
    //    FormMode = "New Mode";
    //}
    //else {
    //    FormMode = "Edit Mode";
    //    header.insertButton('<button class="btn" id="webformaudittrail"><i class="fa fa-history" aria-hidden="true"></i></button>');
    //    header.insertButton(' <button class="btn" id="webformnew" onclick="window.location.href = window.location.href" title="New form"><i class="fa fa-file-o" aria-hidden="true"></i></button>');
    //    _editModeObj = JSON.parse(atob(_editModeObj));
    //}
    //header.setName(_formObj.DisplayName);
    //header.setMode(`<span class="fmode"style="color: #444;font-weight: normal;">(${FormMode})</span>`);
    //$('title').text(_formObj.DisplayName);



    $("#webformaudittrail").on("click", function () {
        $("#AuditHistoryModal").modal("show");
        $("#divAuditTrail").children().remove();
        $("#divAuditTrail").append(`<div style="text-align: center;  position: relative; top: 50%;"><i class="fa fa-spinner fa-pulse" aria-hidden="true"></i> Loading...</div>`);
        $.ajax({
            type: "POST",
            url: "../WebForm/GetAuditTrail",
            data: { refid: _formRefId, rowid: renderer.rowId },
            error: function () {
                $("#divAuditTrail").children().remove();
                $("#divAuditTrail").append(`<div style="text-align: center;  position: relative; top: 50%; font-size: 20px; color: #ccc; "> Something unexpected occured </div>`);
            },
            success: function (result) {
                if (result === "{}") {
                    $("#divAuditTrail").children().remove();
                    $("#divAuditTrail").append(`<div style="text-align: center; position: relative; top: 50%; font-size: 20px; color: #ccc; "> Nothing to Display </div>`);
                    return;
                }
                else if (result === "") {
                    $("#divAuditTrail").children().remove();
                    $("#divAuditTrail").append(`<div style="text-align: center;  position: relative; top: 50%; font-size: 20px; color: #ccc; "> Something went wrong </div>`);
                    return;
                }
                drawAuditTrail(result);
            }
        });
    });

    function drawAuditTrail(result) {
        let auditObj = JSON.parse(result);
        let missingAE = false;
        var appendHtml = ``;
        $.each(auditObj, function (idx, Obj) {
            appendHtml += `<table class="table first-table" style="width:100%; margin: 0px;">
                            <thead>`;
            if (missingAE)
                appendHtml += `<tr><th colspan="3" style="color: red; text-align: center;">Missing audit trail entry identified</th></tr>`;
            appendHtml +=       `<tr class="trans-title-tr">
                                    <th class="col-md-4 col-sm-4">Event DateTime: ${Obj.CreatedAt}</th>
                                    <th class="col-md-4 col-sm-4">Operation: ${Obj.ActionType}</th>
                                    <th class="col-md-4 col-sm-4">Done By: ${Obj.CreatedBy}</th>
                                </tr>
                            </thead>
                            <tbody>`;
            if (Obj.MissingEntry)
                missingAE = true;
            else
                missingAE = false;

            let tempHtml = ``;                        
            $.each(Obj.Tables, function (i, Tbl) {
                $.each(Tbl.Columns, function (j, Row) {
                    tempHtml += `
                        <tr>
                            <td class="col-md-4 col-sm-4">${j}</td>
                            <td class="col-md-4 col-sm-4">${Row.NewValue}</td>
                            <td class="col-md-4 col-sm-4">${Row.OldValue}</td>
                        </tr>`;
                });
            });
            if (tempHtml.length !== 0) {
                appendHtml += ` <tr class="table-title-tr">                            
                                    <th class="col-md-4 col-sm-4">Field Name</th>
                                    <th class="col-md-4 col-sm-4">New Value</th>
                                    <th class="col-md-4 col-sm-4">Old Value</th>
                                </tr>` + tempHtml;
            }

            appendHtml += `</tbody></table>`;

            $.each(Obj.GridTables, function (i, Tbl) {
                appendHtml += `<table class="table table-bordered second-table" style="width:100%; margin: 0px;">
                                <thead>
                                    <tr class="table-title-tr">
                                        <th></th>`;
                $.each(Tbl.ColumnMeta, function (j, cmeta) {
                    appendHtml += `<th>${cmeta}</th>`;
                });
                appendHtml += `     </tr>
                                </thead><tbody>`;
                $.each(Tbl.Rows, function (m, Cols) {
                    let newRow = `<tr><td>New</td>`;
                    let oldRow = `<tr><td>Old</td>`;
                    $.each(Cols.Columns, function (n, Col) {
                        if (Col.IsModified)
                            newRow += `<td style="color: red;">${Col.NewValue}</td>`;                            
                        else
                            newRow += `<td>${Col.NewValue}</td>`;
                        oldRow += `<td>${Col.OldValue}</td>`;
                    });
                    newRow += `</tr>`;
                    oldRow += `</tr>`;
                    appendHtml += newRow + oldRow;
                });
                
                appendHtml += `</tbody></table>`;
            });
        });
        
        $("#divAuditTrail").children().remove();
        $("#divAuditTrail").append(appendHtml);
    }

    function getAudiTrailHtml(tables, level) {
        if (Object.entries(tables).length === 0)
            return ``;
        let appendHtml = ``;
        $.each(tables, function (i, tblObj) {
            appendHtml += `<tr class="success"><td class="col-md-12 col-sm-12" style = "padding-top: 0px; padding-bottom: 0px; padding-left: ${(level * 16) + 8}px;"><i class="fa fa-chevron-down" aria-hidden="true" style="color: #aaa;"></i> Container: ${i}</td></tr>`;
            $.each(tblObj.Rows, function (j, rowObj) {
                appendHtml += `<tr class="active"><td class="col-md-12 col-sm-12" style = "padding-top: 0px; padding-bottom: 0px; padding-left: ${((level + 1) * 16) + 8}px;"><i class="fa fa-chevron-down" aria-hidden="true" style="color: #aaa;"></i> Record Id: ${j}</td></tr>`;
                $.each(rowObj.Columns, function (k, colObj) {
                    appendHtml += `
                        <tr>
                            <td class="col-md-4 col-sm-4" style="padding-left: ${((level + 2) * 16) + 8}px;">${k}</td>
                            <td class="col-md-4 col-sm-4">${colObj.OldValue}</td>
                            <td class="col-md-4 col-sm-4">${colObj.NewValue}</td>
                        </tr>`;
                });
            });
            appendHtml += getAudiTrailHtmlRec(tblObj.LinesTable, level + 1);
        });
        return appendHtml;
    }
</script>